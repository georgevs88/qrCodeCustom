<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "//iBATIS.com//DTD SQL Map 2.0//EN" "HTTP://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="Vat">
	<typeAlias alias="VatVO" type="pmcg.imti.domain.VatVO" />

	<resultMap class="VatVO" id="mapComplexQuery">
		<result property="codvat" column="codvat" />
		<result property="desvat" column="desvat" />
		<result property="codser" column="codser" />
		<result property="comvat" column="comvat" />
		<result property="cnae" column="cnae" />
		<result property="usualt" column="usualt" />
		<result property="datalt" column="datalt" />
		<result property="cnae_id" column="cnae_id" />
		<result property="serVO" select="Ser.getRegByCodComplex" column="codser"/>
		
		
	</resultMap>


	<select id="getRegByCod" parameterClass="Integer" resultClass="VatVO">
		SELECT *FROM sos.sosvat
		WHERE codvat = #VALUE:NUMERIC#
	</select>

	<select id="getRegByCodComplex" parameterClass="Integer" resultMap="mapComplexQuery">
		SELECT *FROM sos.sosvat
		WHERE codvat = #VALUE:NUMERIC#
	</select>

	<select id="getRegByCriterio" parameterClass="VatVO"
		resultClass="VatVO">
		SELECT *
		FROM sos.sosvat
		<dynamic prepend=" WHERE ">
			<isNotNull property="codvat" prepend=" AND ">
				codvat = #codvat:NUMERIC#
			</isNotNull>
			<isNotNull property="desvat" prepend=" AND ">
				upper (desvat) like
				'%' || upper(#desvat:VARCHAR#) || '%'
			</isNotNull>
			<isNotNull property="codser" prepend=" AND ">
				codser= #codser:NUMERIC#
			</isNotNull>
			<isNotNull property="comvat" prepend=" AND ">
				upper (comvat) like
				'%' || upper(#comvat:VARCHAR#) || '%'
			</isNotNull>
			<isNotNull property="cnae" prepend=" AND ">
				upper (cnae) like '%' ||
				upper(#cnae:VARCHAR#) || '%'
			</isNotNull>
			<isNotNull property="cnae_id" prepend=" AND ">
				cnae_id = #cnae_id:NUMERIC#
			</isNotNull>
			
		</dynamic>
		order by codvat
	</select>
	
	<select id="getRegByCriterioComplex" parameterClass="VatVO"
		resultMap="mapComplexQuery">
		SELECT *
		FROM sos.sosvat
		<dynamic prepend=" WHERE ">
			<isNotNull property="codvat" prepend=" AND ">
				codvat =
				#codvat:NUMERIC#
			</isNotNull>
			<isNotNull property="desvat" prepend=" AND ">
				upper (desvat) like
				'%' || upper(#desvat:VARCHAR#) || '%'
			</isNotNull>
			<isNotNull property="codser" prepend=" AND ">
				codser= #codser:NUMERIC#
			</isNotNull>
			<isNotNull property="comvat" prepend=" AND ">
				upper (comvat) like
				'%' || upper(#comvat:VARCHAR#) || '%'
			</isNotNull>
			<isNotNull property="cnae" prepend=" AND ">
				upper (cnae) like '%' ||
				upper(#cnae:VARCHAR#) || '%'
			</isNotNull>
			<isNotNull property="cnae_id" prepend=" AND ">
				cnae_id = #cnae_id:NUMERIC#
			</isNotNull>
			
		</dynamic>
		order by codvat
	</select>

	<insert id="insReg" parameterClass="VatVO">
		<selectKey keyProperty="codvat" resultClass="Integer">
			SELECT
			NEXTVAL('sos.sosvat_codvat_seq'::regclass)
		</selectKey>
		INSERT INTO sos.sosvat(codvat,desvat,codser,comvat,cnae,usualt,
		datalt,cnae_id)
		VALUES
		(#codvat:NUMERIC#,UPPER(#desvat:VARCHAR#),#codser:NUMERIC#,
		UPPER(#comvat:VARCHAR#), #cnae:VARCHAR#,#usualt:VARCHAR#, now(), #cnae_id:NUMERIC#)
	</insert>

	<select id="getCountByNome" parameterClass="VatVO" resultClass="Integer">
		SELECT
		count(codvat)
		FROM
		sos.sosvat
		WHERE
		UPPER(desvat) = UPPER(#desvat:VARCHAR#)
		<isNotNull property="codvat">
			AND codvat != #codvat:NUMERIC#
		</isNotNull>
	</select>

	<update id="updRegByCod" parameterClass="VatVO">
		UPDATE sos.sosvat SET
		desvat = #desvat:VARCHAR#,
		codser = #codser:NUMERIC#,
		comvat =
		#comvat:VARCHAR#,
		cnae = #cnae:VARCHAR#,
		usualt=#usualt:VARCHAR#,
		datalt=now(),
		cnae_id = #cnae_id:NUMERIC#
		WHERE codvat = #codvat:NUMERIC#
	</update>

	<delete id="delByCod" parameterClass="Integer">
		DELETE FROM sos.sosvat
		WHERE
		codvat = #codvat:NUMERIC#
	</delete>

	<select id="countRegByCriterio" parameterClass="VatVO"
		resultClass="Integer">
		SELECT count(codvat)
		FROM sos.sosvat
		<dynamic prepend=" WHERE ">
			<isNotNull property="codvat" prepend=" AND ">
				codvat =
				#codvat:NUMERIC#
			</isNotNull>
			<isNotNull property="desvat" prepend=" AND ">
				upper (desvat) like
				'%' || upper(#desvat:VARCHAR#) || '%'
			</isNotNull>
			<isNotNull property="codser" prepend=" AND ">
				codser = #codser:NUMERIC#
			</isNotNull>
			<isNotNull property="comvat" prepend=" AND ">
				upper (comvat) like
				'%' || upper(#comvat:VARCHAR#) || '%'
			</isNotNull>
			<isNotNull property="cnae" prepend=" AND ">
				upper (cnae) like '%' ||
				upper(#cnae:VARCHAR#) || '%'
			</isNotNull>
			<isNotNull property="cnae_id" prepend=" AND ">
				cnae_id = #cnae_id:NUMERIC#
			</isNotNull>
		</dynamic>
	</select>
	
	<select id="getRegByCnae" parameterClass="String" resultClass="VatVO">
		SELECT *FROM sos.sosvat
		WHERE upper (cnae) like '%' ||	upper(#value:VARCHAR#) || '%'
	</select>

</sqlMap>