<?xml version="1.0" encoding="UTF-8"?> 
 <!DOCTYPE sqlMap PUBLIC "//iBATIS.com//DTD SQL Map 2.0//EN" "HTTP://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="Cna">
	<typeAlias alias="CnaVO" type="pmcg.fcn.domain.CnaVO" />

	<resultMap id="mapComplexQuerySimple" class="CnaVO">
		<result property="iddcna" column="iddcna" />
		<result property="tipcna" column="tipcna" />
		<result property="filcna" column="filcna" />
		<result property="matcna" column="matcna" />
		<result property="colcna" column="colcna" />
		<result property="codcna" column="codcna" />
		<result property="pricna" column="pricna" />
		<result property="ordcna" column="ordcna" />
		<result property="taecna" column="taecna" />
		<result property="descna" column="descna" />
		<result property="execna" column="execna" />
	</resultMap>

	<resultMap id="mapComplexQuery" class="CnaVO">
		<result property="iddcna" column="iddcna" />
		<result property="tipcna" column="tipcna" />
		<result property="filcna" column="filcna" />
		<result property="matcna" column="matcna" />
		<result property="colcna" column="colcna" />
		<result property="codcna" column="codcna" />
		<result property="pricna" column="pricna" />
		<result property="ordcna" column="ordcna" />
		<result property="taecna" column="taecna" />
		<result property="descna" column="descna" />
		<result property="execna" column="execna" />
	</resultMap>

	<select id="getRegByCod" parameterClass="Long" resultMap="mapComplexQuerySimple">
		SELECT * FROM fcn.fcncna WHERE iddcna = #value:NUMERIC#
	</select>

	<select id="getRegByCodComplex" parameterClass="Long" resultMap="mapComplexQuery">
		SELECT * FROM fcn.fcncna WHERE iddcna = #value:NUMERIC#
	</select>

	<select id="getRegByCriterio" parameterClass="CnaVO"
		resultMap="mapComplexQuerySimple">
		SELECT * FROM fcn.fcncna
		<dynamic prepend=" WHERE ">
			<isNotNull property="iddcna" prepend=" AND ">
				iddcna = #iddcna:NUMERIC#
			</isNotNull>
			<isNotNull property="tipcna" prepend=" AND ">
				tipcna ILIKE '%' || #tipcna:VARCHAR# || '%'
			</isNotNull>
			<isNotNull property="filcna" prepend=" AND ">
				filcna = #filcna:NUMERIC#
			</isNotNull>
			<isNotNull property="matcna" prepend=" AND ">
				matcna = #matcna:NUMERIC#
			</isNotNull>
			<isNotNull property="colcna" prepend=" AND ">
				colcna = #colcna:NUMERIC#
			</isNotNull>
			<isNotNull property="codcna" prepend=" AND ">
				codcna like #codcna:VARCHAR#
			</isNotNull>
			<isNotNull property="pricna" prepend=" AND ">
				pricna = #pricna:NUMERIC#
			</isNotNull>
			<isNotNull property="ordcna" prepend=" AND ">
				ordcna = #ordcna:NUMERIC#
			</isNotNull>
		</dynamic>
	</select>

	<select id="getRegByCriterioComplex" parameterClass="CnaVO"
		resultMap="mapComplexQuery">
		SELECT * FROM fcn.fcncna
		<dynamic prepend=" WHERE ">
			<isNotNull property="iddcna" prepend=" AND "> iddcna =
				#iddcna:NUMERIC#
			</isNotNull>
			<isNotNull property="tipcna" prepend=" AND ">
				tipcna ILIKE '%' || #tipcna:VARCHAR# || '%'
			</isNotNull>
			<isNotNull property="filcna" prepend=" AND "> filcna =
				#filcna:NUMERIC#
			</isNotNull>
			<isNotNull property="matcna" prepend=" AND "> matcna =
				#matcna:NUMERIC#
			</isNotNull>
			<isNotNull property="colcna" prepend=" AND "> colcna =
				#colcna:NUMERIC#
			</isNotNull>
			<isNotNull property="codcna" prepend=" AND "> codcna =
				#codcna:VARCHAR#
			</isNotNull>
			<isNotNull property="pricna" prepend=" AND "> pricna =
				#pricna:NUMERIC#
			</isNotNull>
			<isNotNull property="ordcna" prepend=" AND "> ordcna =
				#ordcna:NUMERIC#
			</isNotNull>
		</dynamic>
	</select>

	<select id="getTodos" resultMap="mapComplexQuerySimple">
		SELECT * FROM fcn.fcncna
	</select>

	<insert id="insReg" parameterClass="CnaVO">
		<selectKey keyProperty="iddcna" resultClass="Long">
			SELECT NEXTVAL('fcn.seqcna')
		</selectKey>
		INSERT INTO
		fcn.fcncna(iddcna,tipcna,filcna,matcna,colcna,codcna,pricna,ordcna,taecna,descna,execna)
		VALUES (#iddcna:NUMERIC#,
		UPPER(#tipcna:VARCHAR#),#filcna:NUMERIC#,#matcna:NUMERIC#,#colcna:NUMERIC#,#codcna:VARCHAR#,#pricna:NUMERIC#,
		#ordcna:NUMERIC#,#taecna:VARCHAR#,#descna:VARCHAR#,#execna:BOOLEAN#
		)
	</insert>

	<update id="updRegByCod" parameterClass="CnaVO">
		UPDATE fcn.fcncna SET tipcna= UPPER(#tipcna:VARCHAR#),filcna=
		#filcna:NUMERIC#,matcna= #matcna:NUMERIC#,colcna=
		#colcna:NUMERIC#,codcna= #codcna:VARCHAR#,pricna=
		#pricna:NUMERIC#,ordcna= #ordcna:NUMERIC#,taecna=#taecna:VARCHAR#,descna=#descna:VARCHAR#,execna = #execna:BOOLEAN# WHERE iddcna =
		#iddcna:NUMERIC#
	</update>
	
	<delete id="delByCod" parameterClass="Long">
		DELETE FROM fcn.fcncna WHERE iddcna = #value:NUMERIC#
	</delete>
	
	<delete id="delByCodigos" parameterClass="String">
		DELETE FROM fcn.fcncna WHERE iddcna in ($value$)
	</delete>

	<select id="getCountByCriterio" parameterClass="CnaVO"
		resultClass="Integer">
		SELECT count(iddcna) FROM fcn.fcncna
		<dynamic prepend=" WHERE ">
			<isNotNull property="iddcna" prepend=" AND "> iddcna =
				#iddcna:NUMERIC#
			</isNotNull>
			<isNotNull property="tipcna" prepend=" AND ">
				tipcna ILIKE '%' || #tipcna:VARCHAR# || '%'
			</isNotNull>
			<isNotNull property="filcna" prepend=" AND "> filcna =
				#filcna:NUMERIC#
			</isNotNull>
			<isNotNull property="matcna" prepend=" AND "> matcna =
				#matcna:NUMERIC#
			</isNotNull>
			<isNotNull property="colcna" prepend=" AND "> colcna =
				#colcna:NUMERIC#
			</isNotNull>
			<isNotNull property="codcna" prepend=" AND "> codcna =
				#codcna:VARCHAR#
			</isNotNull>
			<isNotNull property="pricna" prepend=" AND "> pricna =
				#pricna:NUMERIC#
			</isNotNull>
			<isNotNull property="ordcna" prepend=" AND "> ordcna =
				#ordcna:NUMERIC#
			</isNotNull>
		</dynamic>
	</select>
	
	<select id="getRegByProtocoloVia" parameterClass="String" resultClass="CnaVO">
		select cna.* from fcn.fcnvia via
		join fcn.fcncol col on via.colvia = col.iddcol
		join fcn.fcncna cna on cna.colcna = col.iddcol
		where provia like #value:VARCHAR#
	</select>
	
	<select id="getRegByProcessoMatriz" parameterClass="String" resultClass="CnaVO">
		SELECT 
			cna.* 
		FROM 
			fcn.fcnepd epd
			join fcn.fcnpro pro on pro.iddpro = epd.proepd 
			join fcn.fcnmat mat on mat.promat = pro.iddpro
			join fcn.fcncna cna on cna.matcna = mat.iddmat
		where 
			epd.nprepd like #value:VARCHAR#
	</select>
	
	<select id="getRegByMatriz" parameterClass="Long" resultClass="hashmap">
		SELECT 
			substr(cna.codcna, 1,4) || '-' || substr(cna.codcna, 5,1) || '/' || substr(cna.codcna, 6,2) || '-' || case when cna.descna is not null then '0' || cna.descna else '000' end as codcna,
            atv.nomccl as descna, case when cna.pricna = 1 then 'SIM' else 'NAO' end as pricna
		FROM 
			fcn.fcncna cna
            left join fcn.fcnccl atv on atv.codccl = (substr(cna.codcna, 1,4) || '-' || substr(cna.codcna, 5,1) || '/' || substr(cna.codcna, 6,2) || '-' || case when cna.descna is not null then '0' || cna.descna else '000' end)
		where 
			cna.matcna = #value:NUMERIC#
        order by 
        	cna.ordcna
    </select>
	
	<select id="getRegByFilial" parameterClass="Long" resultClass="hashmap">
		SELECT 
			substr(cna.codcna, 1,4) || '-' || substr(cna.codcna, 5,1) || '/' || substr(cna.codcna, 6,2) || '-' || case when cna.descna is not null then '0' || cna.descna else '000' end as codcna,
            atv.nomccl as descna, case when cna.pricna = 1 then 'SIM' else 'NAO' end as pricna
		FROM 
			fcn.fcncna cna
            left join fcn.fcnccl atv on atv.codccl = (substr(cna.codcna, 1,4) || '-' || substr(cna.codcna, 5,1) || '/' || substr(cna.codcna, 6,2) || '-' || case when cna.descna is not null then '0' || cna.descna else '000' end)
		where 
			cna.filcna = #value:NUMERIC#
		order by 
			cna.ordcna
	</select>
	
	<select id="getRegByProvia" parameterClass="String" resultClass="hashmap">
		select 
			fcn.formatacnae(cna.codcna || case when cna.descna is not null then cna.descna else '' end) as codcna,
            atv.nomccl as descna, case when cna.pricna = 1 then 'SIM' else 'NAO' end as pricna
		from 
			fcn.fcncna cna
			left join fcn.fcnccl atv on atv.codccl = fcn.formatacnae(cna.codcna || case when cna.descna is not null then cna.descna else '' end)
			join fcn.fcncol col on col.iddcol = colcna
			join fcn.fcnvia via on via.colvia = col.iddcol
		where 
			via.provia = #value:VARCHAR#
	</select>
	
</sqlMap> 
 